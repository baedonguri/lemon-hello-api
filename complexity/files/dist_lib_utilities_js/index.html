<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Plato - dist/lib/utilities.js</title>

  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="">
  <meta name="author" content="">

  <!--[if lt IE 9]>
  <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
  <![endif]-->

  <link href="../../assets/css/vendor/morris.css" rel="stylesheet">
  <link href="../../assets/css/vendor/bootstrap.css" rel="stylesheet">
  <link href="../../assets/css/vendor/font-awesome.css" rel="stylesheet">
  <link href="../../assets/css/vendor/codemirror.css" rel="stylesheet">
  <link href="../../assets/css/plato.css" rel="stylesheet">
  <link href="../../assets/css/plato-file.css" rel="stylesheet">

</head>

<body>

<div class="navbar navbar-fixed-top">
  <div class="container">
    <a class="navbar-brand" href="http://github.com/es-analysis/plato">Plato on Github</a>
    <ul class="nav navbar-nav">
      <li>
        <a href="../../index.html">Report Home</a>
      </li>
    </ul>
  </div>
</div>

<div class="jumbotron">
  <div class="container">
    <h1>dist/lib/utilities.js</h1>
  </div>
</div>

<div class="container aggregate-stats">
  <div class="row">
    <div class="col-md-6">
      <h2 class="header">Maintainability <a href="http://blogs.msdn.com/b/codeanalysis/archive/2007/11/20/maintainability-index-range-and-meaning.aspx"><i class="icon icon-info-sign" rel="popover" data-placement="top" data-trigger="hover" data-content="A value between 0 and 100 that represents the relative ease of maintaining the code. A high value means better maintainability." data-original-title="Maintainability Index"  data-container="body"></i></a></h2>
      <p class="stat">67.56</p>
    </div>
    <div class="col-md-6">
      <h2 class="header">Lines of code <i class="icon icon-info-sign" rel="popover" data-placement="top" data-trigger="hover" data-content="Source Lines of Code / Logical Lines of Code" data-original-title="SLOC/LSLOC" data-container="body"></i></h2>
      <p class="stat">519</p>
    </div>
  </div>
  <div class="row historical">
    <div class="col-md-6">
      <p id="chart_historical_maint" class="chart"></p>
    </div>
    <div class="col-md-6">
      <p id="chart_historical_sloc" class="chart"></p>
    </div>
  </div>
  <div class="row">
    <div class="col-md-6">
      <h2 class="header">Difficulty  <a href="http://en.wikipedia.org/wiki/Halstead_complexity_measures"><i class="icon icon-info-sign" rel="popover" data-placement="top" data-trigger="hover" data-content="The difficulty measure is related to the difficulty of the program to write or understand." data-original-title="Difficulty" data-container="body"></i></a></h2>
      <p class="stat">74.09</p>
    </div>
    <div class="col-md-6">
      <h2 class="header">Estimated Errors  <a href="http://en.wikipedia.org/wiki/Halstead_complexity_measures"><i class="icon icon-info-sign" rel="popover" data-placement="top" data-trigger="hover" data-content="Halstead's delivered bugs is an estimate for the number of errors in the implementation." data-original-title="Delivered Bugs" data-container="body"></i></a></h2>
      <p class="stat">5.21</p>
    </div>
  </div>
</div>

<div class="container charts">
  <div class="row">
    <h2 class="header">Function weight</h2>
  </div>
  <div class="row">
    <div class="col-md-6">
      <h3 class="chart-header">By Complexity <a href="http://en.wikipedia.org/wiki/Cyclomatic_complexity"><i class="icon icon-info-sign" rel="popover" data-placement="top" data-trigger="hover" data-content="This metric counts the number of distinct paths through a block of code. Lower values are better." data-original-title="Cyclomatic Complexity" data-container="body"></i></a></h3>
      <div id="fn-by-complexity" class="stat"></div>
    </div>
    <div class="col-md-6">
      <h3 class="chart-header">By SLOC  <i class="icon icon-info-sign" rel="popover" data-placement="top" data-trigger="hover" data-content="Source Lines of Code / Logical Lines of Code" data-original-title="SLOC/LSLOC" data-container="body"></i></h3>
      <div id="fn-by-sloc" class="stat"></div>
    </div>
  </div>
</div>

<div class="container">
  <div class="row">
    <textarea id="file-source" class="col-md-12">/**
 * Common utilities.
 *
 *
 * @author  Steve &lt;steve@lemoncloud.io)
 * @date    2019-07-19
 *
 * @copyright (C) lemoncloud.io 2019 - All Rights Reserved.
 */
module.exports = _$ =&gt; {
  &#039;use strict&#039;;

  const thiz = {}; // var _request = require(&#039;request&#039;);
  // var _promise = require(&#039;bluebird&#039;);
  // if(!_request) throw new Error(&#039;request is required!&#039;);

  const NS = _NS(&#039;util&#039;); // use underscore util.


  const $_ = _$._; // re-use global instance (utils).

  if (!$_) throw new Error(&#039;$_ is required!&#039;); //////////////////////////////////////////////////
  // define public exports.

  thiz.name = `${NS}-utils`;
  thiz.ts = _ts; // timestamp

  thiz.dt = _dt; // date

  thiz.now = _dt; // now

  thiz.escape = _escape; // escape string

  thiz.cleanup = _cleanup; // clean-up &#039;_&#039;, &#039;$&#039; members.

  thiz.updated = _updated; // clean-up &#039;_&#039;, &#039;$&#039; members.

  thiz.copy = _copy; // shollow copy object.

  thiz.N = _N; // Number conversion.

  thiz.F = _F; // Number conversion.

  thiz.current_time_ms = _current_time_ms; // Current millisecond time (UTC+0)

  thiz.NS = _NS; // NameSpace Maker.

  thiz.env = get_env;
  thiz.extend = _extend; // extends object

  thiz.isset = _isset; // check undefined.

  thiz.empty = _empty; // check valid

  thiz.min = _min; // min

  thiz.max = _max; // max

  thiz.round = _round; // round

  thiz.json = _json; // JSON function to stringify

  thiz.diff = _diff; // Object Different.

  thiz.copy_node = _copy_node; // copy object without &#039;_&#039;, &#039;$&#039; members.

  thiz.bare_node = _bare_node; // Bare Node with only core members.

  thiz.diff_node = _diff_node; // Node Different by ignoring &#039;_&#039;,&#039;$&#039; members.

  thiz.hash = _hash; // Get Hash Value (32-bits)

  thiz.md5 = _md5; // Get md5 hash Value with encoding(default hex, base64)

  thiz.hmac = _hmac; // Get hmac key-validate hash Value

  thiz.logger_factory = _logger_factory; //! logger factory : logger_factory().create(&#039;hi&#039;);

  thiz.promise = _promise; //! promise 객체를 준비.

  thiz.promise_sequence = _promise_sequence; //! array() 들에 대해서 하나씩 실행할 수 있음.
  //////////////////////////////////////////////////
  // Function Definitions.

  var _log = _log || _$.log || function () {
    return dummy_log(arguments, &#039;I&#039;);
  };

  var _err = _err || _$.err || function () {
    return dummy_log(arguments, &#039;E&#039;);
  };

  var _is_dev = _is_dev || function () {
    var env = get_env(&#039;ENV&#039;) || get_env(&#039;NODE_ENV&#039;) || get_env(&#039;STAGE&#039;);
    return env === &#039;production&#039; || env === &#039;op&#039; ? false : true;
  }; //! exports functions.


  thiz.log = _log;
  thiz.err = _err;
  thiz.is_dev = _is_dev(); //! some helper function.s

  function get_env(name, def_val) {
    // ovrride get_env() function.
    if (typeof _$.get_env === &#039;function&#039;) return _$.get_env(name, def_val);
    if (typeof _$.environ === &#039;function&#039;) return _$.environ(name, def_val); // as default, load from proces.env.

    let val = process &amp;&amp; process.env[name] || undefined;
    return val === undefined ? def_val : val;
  } // dummy logger.


  function _logger_factory() {
    //env = env||process.env||{};
    return {
      create: function (name, path) {
        name = name || NS;
        path = path || &#039;/var/www/html/logs/&#039;;

        let log4js = require(&#039;log4js&#039;);

        let log_file = path + name + &#039;.log&#039;;
        log4js.loadAppender(&#039;file&#039;);
        log4js.addAppender(log4js.appenders.file(log_file), name);
        return log4js.getLogger(name);
      }
    };
  } //WARN! DO NOT MAKE LOGGER IN HERE.


  var _logger = 1 ? null : _logger_factory &amp;&amp; _logger_factory.create(get_env(&#039;ENV&#039;) || &#039;op&#039;);

  var dummy_log = function (args, t) {
    if (_logger) {
      if (t == &#039;E&#039;) {
        _logger.error.apply(_logger, args);
      } else {
        _logger.info.apply(_logger, args);
      }
    } else if (typeof console != &#039;undefined&#039;) {
      if (true) {
        if (!Array.isArray(args)) {
          args = Array.prototype.slice.call(args);
        }

        if (t) args.unshift(t);
        args.unshift(_ts());
      }

      if (t == &#039;E&#039;) {
        // eslint-disable-next-line no-console
        console.error.apply(console, args);
      } else {
        // eslint-disable-next-line no-console
        console.log.apply(console, args);
      }
    }

    return true;
  };

  function _extend(a, b) {
    for (var x in b) a[x] = b[x];

    return a;
  }

  function _isset(x) {
    return x === undefined ? false : true;
  }

  function _empty(x) {
    return x ? false : true;
  }

  function _min(a, b) {
    return a &lt; b ? a : b;
  }

  function _max(a, b) {
    return a &gt; b ? a : b;
  }

  function _round(a) {
    return Math.round(a);
  }

  function _json(o, isSorted) {
    if (isSorted) {
      var output = {};
      Object.keys(o).sort().forEach(function (key) {
        output[key] = o[key];
      });
      o = output;
    }

    return o &amp;&amp; JSON.stringify(o) || o;
  } // timestamp value.


  function _ts($d) {
    var dt = $d &amp;&amp; typeof $d === &#039;object&#039; ? $d : $d ? new Date($d) : new Date();
    var y = dt.getFullYear();
    var m = dt.getMonth() + 1; //Months are zero based

    var d = dt.getDate();
    var h = dt.getHours();
    var i = dt.getMinutes();
    var s = dt.getSeconds();
    var ret = (y &lt; 10 ? &#039;0&#039; : &#039;&#039;) + y + &#039;-&#039; + (m &lt; 10 ? &#039;0&#039; : &#039;&#039;) + m + &#039;-&#039; + (d &lt; 10 ? &#039;0&#039; : &#039;&#039;) + d + &#039; &#039; + (h &lt; 10 ? &#039;0&#039; : &#039;&#039;) + h + &#039;:&#039; + (i &lt; 10 ? &#039;0&#039; : &#039;&#039;) + i + &#039;:&#039; + (s &lt; 10 ? &#039;0&#039; : &#039;&#039;) + s;
    return ret;
  } // parse timestamp to date.


  function _dt(ts) {
    ts = ts || _ts();
    var aa = ts.split(&#039; &#039;);
    var dd = aa[0].split(&#039;-&#039;);
    var hh = aa[1].split(&#039;:&#039;);
    var y = parseInt(dd[0]),
        m = parseInt(dd[1]) - 1,
        d = parseInt(dd[2]);
    var h = parseInt(hh[0]),
        i = parseInt(hh[1]),
        s = parseInt(hh[2]); //! addtional function: add_seconds()

    if (!Date.prototype.add_seconds) {
      Date.prototype.add_seconds = function (dx) {
        this.setSeconds(this.getSeconds() + dx);
        return this;
      };
    } //! format to time-stamp.


    if (!Date.prototype.ts) {
      Date.prototype.ts = function () {
        return _ts(this);
      };
    }

    var dt = new Date(y, m, d, h, i, s, 0);
    return dt;
  }
  /**
   * 현재 시간값 (number of milliseconds since midnight of January 1, 1970.)
   *
   *
   * @returns {number}
   */


  function _current_time_ms() {
    //TODO:XENI - 서버와 시간 동기화를 위해서, 디비서버에등에서 일체화된 시간 동기값을 환산하여 준다.
    var time_shift = 0;
    var ret = new Date().getTime();
    ret += time_shift;
    return ret;
  }
  /**
   * NameSpace Maker.
   *
   * @returns {string}
   */


  function _NS(ns, color, len) {
    if (!ns) return ns;
    len = len || 4;
    len = len - ns.length;
    len = len &lt; 0 ? 0 : len;
    const SPACE = &#039;           &#039;;
    ns = SPACE.substr(0, len) + ns + &#039;:&#039;;

    if (thiz.is_dev &amp;&amp; color) {
      const COLORS = {
        red: &#039;\x1b[31m&#039;,
        green: &#039;\x1b[32m&#039;,
        yellow: &#039;\x1b[33m&#039;,
        blue: &#039;\x1b[34m&#039;,
        magenta: &#039;\x1b[35m&#039;,
        cyan: &#039;\x1b[36m&#039;,
        white: &#039;\x1b[37m&#039;
      };
      ns = COLORS[color] + ns + &#039;\x1b[0m&#039;;
    }

    return ns;
  } // escape string for mysql.


  function _escape(str, urldecode) {
    if (str === undefined) return &#039;NULL&#039;;
    if (isInteger(str)) return str;
    str = str || &#039;&#039;;

    if (typeof str == &#039;object&#039;) {
      str = JSON.stringify(str);
    }

    str = str.replace(/\\/g, &#039;\\\\&#039;).replace(/\$/g, &#039;\\$&#039;).replace(/&#039;/g, &quot;\\&#039;&quot;).replace(/&quot;/g, &#039;\\&quot;&#039;);

    if (urldecode) {
      // url-decode
      str = decodeURI(str);
    }

    return &quot;&#039;&quot; + str + &quot;&#039;&quot;;
  } // convert to integer.


  function isInteger(x) {
    return typeof x === &#039;number&#039; &amp;&amp; x % 1 === 0;
  }

  function _N(x, def) {
    try {
      if (x === &#039;&#039; || x === undefined || x === null) return def;
      if (typeof x === &#039;number&#039; &amp;&amp; x % 1 === 0) return x;
      if (typeof x == &#039;number&#039;) return parseInt(x);
      x = &#039;0&#039; + x;
      x = x.startsWith(&#039;0-&#039;) ? x.substr(1) : x; // minus

      return parseInt(x.replace(/,/gi, &#039;&#039;).trim());
    } catch (e) {
      _err(&#039;err at _N: x=&#039; + x + &#039;;&#039; + typeof x + &#039;;&#039; + (e.message || &#039;&#039;), e);

      return def;
    }
  } //! parse float number (like 1.01)


  function _F(x, def) {
    try {
      if (x === &#039;&#039; || x === undefined || x === null) return def;
      if (typeof x === &#039;number&#039; &amp;&amp; x % 1 === 0) return x;
      if (typeof x == &#039;number&#039;) return parseFloat(x);
      x = &#039;0&#039; + x;
      x = x.startsWith(&#039;0-&#039;) ? x.substr(1) : x; // minus

      return parseFloat(x.replace(/,/gi, &#039;&#039;).trim());
    } catch (e) {
      _err(&#039;err at _N: x=&#039; + x + &#039;;&#039; + typeof x + &#039;;&#039; + (e.message || &#039;&#039;), e);

      return def;
    }
  } //! remove underscore variables.


  function _cleanup($N) {
    return Object.keys($N).reduce(function ($N, key) {
      if (key.startsWith(&#039;_&#039;)) delete $N[key];
      if (key.startsWith(&#039;$&#039;)) delete $N[key];
      return $N;
    }, $N);
  } //! remove underscore variables.


  function _updated(that, that2) {
    const updated = Object.keys(that2).reduce((self, key) =&gt; {
      if (that[key] !== that2[key]) {
        if (that[key] === null &amp;&amp; that2[key] === &#039;&#039;) {
          // both same.
          return self;
        }

        self[key] = that2[key];
      }

      return self;
    }, {});
    return updated;
  }

  function _copy($N) {
    return Object.keys($N).reduce(function ($n, key) {
      $n[key] = $N[key];
      return $n;
    }, {});
  }

  function _copy_node($N, isClear) {
    isClear = isClear === undefined ? false : isClear;
    return Object.keys($N).reduce(function ($n, key) {
      if (key.startsWith(&#039;_&#039;)) return $n;
      if (key.startsWith(&#039;$&#039;)) return $n;
      $n[key] = isClear ? null : $N[key];
      return $n;
    }, {});
  } //! clean up all member without only KEY member.


  function _bare_node($N, opts) {
    // return Object.keys($N).reduce(function($n, key) {
    // 	if(key.startsWith(&#039;_&#039;)) return $n;
    // 	if(key.startsWith(&#039;$&#039;)) return $n;
    // 	$n[key] = $N[key]
    // 	return $n;
    // }, {})
    let $n = {};
    $n._id = $N._id;
    $n._current_time = $N._current_time;
    if (opts) $n = _extend($n, opts);
    return $n;
  }

  function _diff(obj1, obj2) {
    const diff = Object.keys(obj1).reduce((result, key) =&gt; {
      if (!obj2.hasOwnProperty(key)) {
        result.push(key);
      } else if ($_.isEqual(obj1[key], obj2[key])) {
        const resultKeyIndex = result.indexOf(key);
        result.splice(resultKeyIndex, 1);
      }

      return result;
    }, Object.keys(obj2));
    return diff;
  }

  function _diff_node(obj1, obj2) {
    let keys1 = [],
        keys2 = [];
    Object.keys(obj1).forEach(key =&gt; {
      if (key.startsWith(&#039;_&#039;)) return;
      if (key.startsWith(&#039;$&#039;)) return;
      keys1.push(key);
    });
    Object.keys(obj2).forEach(key =&gt; {
      if (key.startsWith(&#039;_&#039;)) return;
      if (key.startsWith(&#039;$&#039;)) return;
      keys2.push(key);
    });
    const diff = keys1.reduce((result, key) =&gt; {
      if (!obj2.hasOwnProperty(key)) {
        result.push(key);
      } else if ($_.isEqual(obj1[key], obj2[key])) {
        const resultKeyIndex = result.indexOf(key);
        result.splice(resultKeyIndex, 1);
      }

      return result;
    }, keys2);
    return diff;
  }

  function _hash(data) {
    data = data || &#039;&#039;;
    data = typeof data === &#039;object&#039; ? _json(data, true) : data; //WARN! it must be sorted json.

    data = typeof data !== &#039;string&#039; ? String(data) : data;
    /**
     * Calculate a 32 bit FNV-1a hash
     * Found here: https://gist.github.com/vaiorabbit/5657561
     * Ref.: http://isthe.com/chongo/tech/comp/fnv/
     *
     * @param {string} str the input value
     * @param {boolean} [asString=false] set to true to return the hash value as
     *     8-digit hex string instead of an integer
     * @param {integer} [seed] optionally pass the hash of the previous chunk
     * @returns {integer | string}
     */

    const hashFnv32a = function (str, asString, seed) {
      /*jshint bitwise:false */
      let i, l;
      let hval = seed === undefined ? 0x811c9dc5 : seed;

      for (i = 0, l = str.length; i &lt; l; i++) {
        hval ^= str.charCodeAt(i);
        hval += (hval &lt;&lt; 1) + (hval &lt;&lt; 4) + (hval &lt;&lt; 7) + (hval &lt;&lt; 8) + (hval &lt;&lt; 24);
      }

      if (asString) {
        // Convert to 8 digit hex string
        return (&#039;0000000&#039; + (hval &gt;&gt;&gt; 0).toString(16)).substr(-8);
      }

      return hval &gt;&gt;&gt; 0;
    };

    return hashFnv32a(data);
  } //! start promise chain.


  function _promise(param) {
    return new Promise(function (resolve, reject) {
      resolve(param);
    });
  } //! promise in sequence.
  // example) promise_sequence([1,2,3], item =&gt; item+1);


  function _promise_sequence(array, func) {
    let chain = _promise(array.shift());

    chain = array.reduce((chain, item) =&gt; {
      return chain.then(() =&gt; func(item));
    }, chain.then(item =&gt; func(item)));
    return chain;
  }

  function _md5(data, digest) {
    const crypto = require(&#039;crypto&#039;);

    digest = digest === undefined ? &#039;hex&#039; : digest;
    return crypto.createHash(&#039;md5&#039;).update(data).digest(digest);
  }

  function _hmac(data, KEY, algorithm, encoding) {
    const crypto = require(&#039;crypto&#039;);

    KEY = KEY || &#039;XENI&#039;;
    encoding = encoding || &#039;base64&#039;;
    algorithm = algorithm || &#039;sha256&#039;;
    return crypto.createHmac(algorithm, KEY).update(data).digest(encoding);
  }

  return thiz;
};</textarea>
  </div>
</div>

<footer class="footer">
  <div class="container">
    <p>.</p>
  </div>
</footer>

<script type="text/html" id="complexity-popover-template">
  <div class="complexity-notice">
    Complexity : {{ cyclomatic }} <br>
    Length : {{ halstead.length }} <br>
    Difficulty : {{ halstead.difficulty.toFixed(2) }} <br>
    Est # bugs : {{ halstead.bugs.toFixed(2) }}<br>
  </div>
</script>

<script type="text/javascript" src="../../assets/scripts/bundles/core-bundle.js"></script>
<script type="text/javascript" src="../../assets/scripts/bundles/codemirror.js"></script>
<script type="text/javascript" src="../../assets/scripts/codemirror.markpopovertext.js"></script>
<script type="text/javascript" src="report.js"></script>
<script type="text/javascript" src="report.history.js"></script>
<script type="text/javascript" src="../../assets/scripts/plato-file.js"></script>
</body>
</html>
