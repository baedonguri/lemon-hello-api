<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Plato - dist/SQS.js</title>

  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="">
  <meta name="author" content="">

  <!--[if lt IE 9]>
  <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
  <![endif]-->

  <link href="../../assets/css/vendor/morris.css" rel="stylesheet">
  <link href="../../assets/css/vendor/bootstrap.css" rel="stylesheet">
  <link href="../../assets/css/vendor/font-awesome.css" rel="stylesheet">
  <link href="../../assets/css/vendor/codemirror.css" rel="stylesheet">
  <link href="../../assets/css/plato.css" rel="stylesheet">
  <link href="../../assets/css/plato-file.css" rel="stylesheet">

</head>

<body>

<div class="navbar navbar-fixed-top">
  <div class="container">
    <a class="navbar-brand" href="http://github.com/es-analysis/plato">Plato on Github</a>
    <ul class="nav navbar-nav">
      <li>
        <a href="../../index.html">Report Home</a>
      </li>
    </ul>
  </div>
</div>

<div class="jumbotron">
  <div class="container">
    <h1>dist/SQS.js</h1>
  </div>
</div>

<div class="container aggregate-stats">
  <div class="row">
    <div class="col-md-6">
      <h2 class="header">Maintainability <a href="http://blogs.msdn.com/b/codeanalysis/archive/2007/11/20/maintainability-index-range-and-meaning.aspx"><i class="icon icon-info-sign" rel="popover" data-placement="top" data-trigger="hover" data-content="A value between 0 and 100 that represents the relative ease of maintaining the code. A high value means better maintainability." data-original-title="Maintainability Index"  data-container="body"></i></a></h2>
      <p class="stat">67.42</p>
    </div>
    <div class="col-md-6">
      <h2 class="header">Lines of code <i class="icon icon-info-sign" rel="popover" data-placement="top" data-trigger="hover" data-content="Source Lines of Code / Logical Lines of Code" data-original-title="SLOC/LSLOC" data-container="body"></i></h2>
      <p class="stat">147</p>
    </div>
  </div>
  <div class="row historical">
    <div class="col-md-6">
      <p id="chart_historical_maint" class="chart"></p>
    </div>
    <div class="col-md-6">
      <p id="chart_historical_sloc" class="chart"></p>
    </div>
  </div>
  <div class="row">
    <div class="col-md-6">
      <h2 class="header">Difficulty  <a href="http://en.wikipedia.org/wiki/Halstead_complexity_measures"><i class="icon icon-info-sign" rel="popover" data-placement="top" data-trigger="hover" data-content="The difficulty measure is related to the difficulty of the program to write or understand." data-original-title="Difficulty" data-container="body"></i></a></h2>
      <p class="stat">32.03</p>
    </div>
    <div class="col-md-6">
      <h2 class="header">Estimated Errors  <a href="http://en.wikipedia.org/wiki/Halstead_complexity_measures"><i class="icon icon-info-sign" rel="popover" data-placement="top" data-trigger="hover" data-content="Halstead's delivered bugs is an estimate for the number of errors in the implementation." data-original-title="Delivered Bugs" data-container="body"></i></a></h2>
      <p class="stat">1.40</p>
    </div>
  </div>
</div>

<div class="container charts">
  <div class="row">
    <h2 class="header">Function weight</h2>
  </div>
  <div class="row">
    <div class="col-md-6">
      <h3 class="chart-header">By Complexity <a href="http://en.wikipedia.org/wiki/Cyclomatic_complexity"><i class="icon icon-info-sign" rel="popover" data-placement="top" data-trigger="hover" data-content="This metric counts the number of distinct paths through a block of code. Lower values are better." data-original-title="Cyclomatic Complexity" data-container="body"></i></a></h3>
      <div id="fn-by-complexity" class="stat"></div>
    </div>
    <div class="col-md-6">
      <h3 class="chart-header">By SLOC  <i class="icon icon-info-sign" rel="popover" data-placement="top" data-trigger="hover" data-content="Source Lines of Code / Logical Lines of Code" data-original-title="SLOC/LSLOC" data-container="body"></i></h3>
      <div id="fn-by-sloc" class="stat"></div>
    </div>
  </div>
</div>

<div class="container">
  <div class="row">
    <textarea id="file-source" class="col-md-12">/**
 * Common SQS Handler in order to dispatch the target handler via SQS common.
 * - `lemon-protocol-api` 에서 각 서비스의 대표 SQS 에 메세지를 전달함.
 * - 그러면, 대표 SQS에 대해서는 이 SQS 핸들러가 데이터를 전달 받고, 이후 해당 API로 전달해줌.
 * - 해당 API 전달은 _$(&#039;api-name&#039;) 으로 찾아서 전달함.
 *
 * [Deploy]
 *  - 이 파일을 각 서비스 프로젝트에 복사하여, handler.js에 SQS 추가 `const SQS = require(&#039;./SQS&#039;)(_$)`.
 *  - `serverless.yml` 의 SQS 생성과 연결 부분을 수정하여 준다.
 *
 *
 *
 * @author Tony Sung &lt;tony@lemoncloud.io&gt;
 * @description     2019-01-17 To support `$protocol().do_post_notify(url, body, callback)`. (engine &gt;1.0.13)
 *
 * @copyright (C) lemoncloud.io 2019 - All Rights Reserved.
 */
module.exports = function (_$) {
  if (!_$) throw new Error(&#039;_$(global instance pool) is required!&#039;); //! load services (_$ defined in global)

  const $_ = _$._; // re-use global instance (lodash).

  const $U = _$.U; // re-use global instance (utils).

  if (!$U) throw new Error(&#039;$U(utillities) is required!&#039;);
  const NS = $U.NS(&#039;SQS&#039;, &#039;yellow&#039;); // NAMESPACE TO BE PRINTED.

  const DEFAULT_TYPE = _$.environ(&#039;DEFAULT_TYPE&#039;, &#039;hello&#039;); //! load common functions


  const _log = _$.log;
  const _inf = _$.inf;
  const _err = _$.err; //! process each record.

  const local_process_record = (record, i) =&gt; {
    _log(`local_process_record(${i})...`);

    const body = record.body || &#039;&#039;;
    const data = typeof body === &#039;string&#039; &amp;&amp; body.startsWith(&#039;{&#039;) &amp;&amp; body.endsWith(&#039;}&#039;) ? JSON.parse(body) : body || {};
    const attributes = record.messageAttributes || {}; //! validate &amp; filter inputs.

    if (!data) return Promise.resolve({
      error: &#039;empty data!&#039;
    }); //! extract parameters....

    const TYPE = data.type || DEFAULT_TYPE || &#039;&#039;;
    const METHOD = (data.method || &#039;get&#039;).toUpperCase();
    const ID = data.id;
    const CMD = data.cmd;
    const PARAM = data.param;
    const BODY = data.body; // transform to APIGatewayEvent;

    const event = {
      httpMethod: METHOD,
      path: CMD ? `/${ID}/${CMD}` : ID !== undefined ? `/${ID}` : &#039;/&#039;,
      headers: {},
      pathParameters: {},
      queryStringParameters: {},
      body: &#039;&#039;,
      isBase64Encoded: false,
      stageVariables: null,
      requestContext: {},
      resource: &#039;&#039;
    };
    if (ID !== undefined) event.pathParameters.id = ID;
    if (CMD !== undefined) event.pathParameters.cmd = CMD;
    if (PARAM) event.queryStringParameters = PARAM;
    if (BODY) event.body = BODY; //! lookup by type....................

    return new Promise((resolve, reject) =&gt; {
      const API = _$(TYPE);

      if (!API) return reject(new Error(`404 NOT FOUND - API.type:${TYPE}`));
      return API(event, {}, (err, res) =&gt; {
        err &amp;&amp; reject(err);
        !err &amp;&amp; resolve(res);
      });
    }).then(res =&gt; {
      const statusCode = res.statusCode || 200;
      const body = typeof res.body === &#039;string&#039; &amp;&amp; res.body.startsWith(&#039;{&#039;) &amp;&amp; res.body.endsWith(&#039;}&#039;) ? JSON.parse(res.body) : res.body;

      _log(NS, `! RES[${statusCode}] =`, typeof body, $U.json(body));

      return statusCode != 200 ? {
        error: body
      } : body;
    }).catch(e =&gt; {
      _err(NS, &#039;! ERR =&#039;, e);

      const msg = e &amp;&amp; e.message || `${e}`;
      return {
        error: msg
      };
    });
  }; // TODO - post message.


  const local_error_handler = (record, error) =&gt; {
    _log(NS, &#039;&gt;&gt; local_error_handler&#039;);

    const body = record.body || {};
    const data = typeof body === &#039;string&#039; &amp;&amp; body.startsWith(&#039;{&#039;) &amp;&amp; body.endsWith(&#039;}&#039;) ? JSON.parse(body) : body || {};
    data.error = error || &#039;N/A&#039;;
    return data;
  }; //! wait some


  function wait_sometime(that, time) {
    time = time || 1500;
    return new Promise((resolve, reject) =&gt; {
      setTimeout(() =&gt; {
        resolve(that);
      }, time);
    });
  } //! retry to process record


  const local_process_record_retry = (record, n) =&gt; local_process_record(record).then(that =&gt; {
    const ERROR = that.error || &#039;&#039;; //! handle error

    if (n &lt;= 1) return local_error_handler(record, ERROR); //! retry

    if (ERROR) {
      _log(NS, `&gt;&gt; retry counts (${n}) due to error: ${ERROR}`);

      return wait_sometime({}, 500).then(_ =&gt; local_process_record_retry(record, n - 1));
    } //! success
    else that;
  }); //! Common SQS Handler for lemon-protocol integration.


  const SQS = function (event, context, callback) {
    //! WARN! allows for using callbacks as finish/error-handlers
    context.callbackWaitsForEmptyEventLoop = false; //! for each SQS record. do service.

    const records = event.Records || [];
    if (!records.length) return callback &amp;&amp; callback(null, 0); //! resolve all.

    return Promise.all(records.map(record =&gt; {
      const RETRY = 3;
      return local_process_record_retry(record, RETRY);
    }));
  }; //! returns main SQS handler.


  return SQS;
};</textarea>
  </div>
</div>

<footer class="footer">
  <div class="container">
    <p>.</p>
  </div>
</footer>

<script type="text/html" id="complexity-popover-template">
  <div class="complexity-notice">
    Complexity : {{ cyclomatic }} <br>
    Length : {{ halstead.length }} <br>
    Difficulty : {{ halstead.difficulty.toFixed(2) }} <br>
    Est # bugs : {{ halstead.bugs.toFixed(2) }}<br>
  </div>
</script>

<script type="text/javascript" src="../../assets/scripts/bundles/core-bundle.js"></script>
<script type="text/javascript" src="../../assets/scripts/bundles/codemirror.js"></script>
<script type="text/javascript" src="../../assets/scripts/codemirror.markpopovertext.js"></script>
<script type="text/javascript" src="report.js"></script>
<script type="text/javascript" src="report.history.js"></script>
<script type="text/javascript" src="../../assets/scripts/plato-file.js"></script>
</body>
</html>
