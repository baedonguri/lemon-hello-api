<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Plato - dist/api/bootload.js</title>

  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="">
  <meta name="author" content="">

  <!--[if lt IE 9]>
  <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
  <![endif]-->

  <link href="../../assets/css/vendor/morris.css" rel="stylesheet">
  <link href="../../assets/css/vendor/bootstrap.css" rel="stylesheet">
  <link href="../../assets/css/vendor/font-awesome.css" rel="stylesheet">
  <link href="../../assets/css/vendor/codemirror.css" rel="stylesheet">
  <link href="../../assets/css/plato.css" rel="stylesheet">
  <link href="../../assets/css/plato-file.css" rel="stylesheet">

</head>

<body>

<div class="navbar navbar-fixed-top">
  <div class="container">
    <a class="navbar-brand" href="http://github.com/es-analysis/plato">Plato on Github</a>
    <ul class="nav navbar-nav">
      <li>
        <a href="../../index.html">Report Home</a>
      </li>
    </ul>
  </div>
</div>

<div class="jumbotron">
  <div class="container">
    <h1>dist/api/bootload.js</h1>
  </div>
</div>

<div class="container aggregate-stats">
  <div class="row">
    <div class="col-md-6">
      <h2 class="header">Maintainability <a href="http://blogs.msdn.com/b/codeanalysis/archive/2007/11/20/maintainability-index-range-and-meaning.aspx"><i class="icon icon-info-sign" rel="popover" data-placement="top" data-trigger="hover" data-content="A value between 0 and 100 that represents the relative ease of maintaining the code. A high value means better maintainability." data-original-title="Maintainability Index"  data-container="body"></i></a></h2>
      <p class="stat">64.00</p>
    </div>
    <div class="col-md-6">
      <h2 class="header">Lines of code <i class="icon icon-info-sign" rel="popover" data-placement="top" data-trigger="hover" data-content="Source Lines of Code / Logical Lines of Code" data-original-title="SLOC/LSLOC" data-container="body"></i></h2>
      <p class="stat">192</p>
    </div>
  </div>
  <div class="row historical">
    <div class="col-md-6">
      <p id="chart_historical_maint" class="chart"></p>
    </div>
    <div class="col-md-6">
      <p id="chart_historical_sloc" class="chart"></p>
    </div>
  </div>
  <div class="row">
    <div class="col-md-6">
      <h2 class="header">Difficulty  <a href="http://en.wikipedia.org/wiki/Halstead_complexity_measures"><i class="icon icon-info-sign" rel="popover" data-placement="top" data-trigger="hover" data-content="The difficulty measure is related to the difficulty of the program to write or understand." data-original-title="Difficulty" data-container="body"></i></a></h2>
      <p class="stat">32.18</p>
    </div>
    <div class="col-md-6">
      <h2 class="header">Estimated Errors  <a href="http://en.wikipedia.org/wiki/Halstead_complexity_measures"><i class="icon icon-info-sign" rel="popover" data-placement="top" data-trigger="hover" data-content="Halstead's delivered bugs is an estimate for the number of errors in the implementation." data-original-title="Delivered Bugs" data-container="body"></i></a></h2>
      <p class="stat">1.59</p>
    </div>
  </div>
</div>

<div class="container charts">
  <div class="row">
    <h2 class="header">Function weight</h2>
  </div>
  <div class="row">
    <div class="col-md-6">
      <h3 class="chart-header">By Complexity <a href="http://en.wikipedia.org/wiki/Cyclomatic_complexity"><i class="icon icon-info-sign" rel="popover" data-placement="top" data-trigger="hover" data-content="This metric counts the number of distinct paths through a block of code. Lower values are better." data-original-title="Cyclomatic Complexity" data-container="body"></i></a></h3>
      <div id="fn-by-complexity" class="stat"></div>
    </div>
    <div class="col-md-6">
      <h3 class="chart-header">By SLOC  <i class="icon icon-info-sign" rel="popover" data-placement="top" data-trigger="hover" data-content="Source Lines of Code / Logical Lines of Code" data-original-title="SLOC/LSLOC" data-container="body"></i></h3>
      <div id="fn-by-sloc" class="stat"></div>
    </div>
  </div>
</div>

<div class="container">
  <div class="row">
    <textarea id="file-source" class="col-md-12">/**
 * bootload.js
 * - basic bootloader for API handler.
 *
 * use like below in api
 * ```js
 * const NS = &#039;ME&#039;;
 * const main = require(&#039;./bootload&#039;)(_$, NS, decode_next_handler);
 * ...
 * return main;
 * ```
 *
 * @author  Steve &lt;steve@lemoncloud.io)
 * @date    2019-07-19
 *
 * @copyright (C) lemoncloud.io 2019 - All Rights Reserved.
 */

/** ********************************************************************************************************************
 *  MAIN EXPORTS
 ** ******************************************************************************************************************* */

/**
 * basic handler function for lambda serverless
 *
 * @param {*} _$       instance manager
 * @param {*} NS       name-space to print
 * @param {*} decode_next_handler  next handler.
 */
module.exports = (_$, NS, decode_next_handler) =&gt; {
  if (!_$) throw new Error(&#039;_$(global instance pool) is required!&#039;);
  if (!NS) throw new Error(&#039;NS (name-space) is required!&#039;);
  if (!decode_next_handler) throw new Error(&#039;decode_next_handler is required!&#039;);
  if (typeof decode_next_handler !== &#039;function&#039;) throw new Error(&#039;decode_next_handler(function) is required!&#039;); //! load services (_$ defined in global)

  const $_ = _$._; // re-use global instance (lodash).

  const $U = _$.U; // re-use global instance (utils).
  //! load common(log) functions

  const _log = _$.log;
  const _inf = _$.inf;
  const _err = _$.err; //! constants config

  const HEADER_LEMON_IDENTITY = &#039;x-lemon-identity&#039;;
  const METHOD_MODE_MAP = &#039;LIST,GET,PUT,POST,CONNECT,DISCONNECT&#039;.split(&#039;,&#039;).reduce((N, K) =&gt; {
    N[K] = K;
    return N;
  }, {});
  /** ********************************************************************************************************************
   *  COMMON Functions.
   ** ******************************************************************************************************************* */

  function buildResponse(statusCode, body) {
    // @0612 - body 가 string일 경우, 응답형식을 텍스트로 바꿔서 출력한다.
    return {
      statusCode,
      headers: {
        &#039;Content-Type&#039;: typeof body === &#039;string&#039; ? &#039;text/plain; charset=utf-8&#039; : &#039;application/json; charset=utf-8&#039;,
        &#039;Access-Control-Allow-Origin&#039;: &#039;*&#039;,
        // Required for CORS support to work
        &#039;Access-Control-Allow-Credentials&#039;: true // Required for cookies, authorization headers with HTTPS

      },
      body: typeof body === &#039;string&#039; ? body : JSON.stringify(body)
    };
  }

  function success(body) {
    return buildResponse(200, body);
  }

  function notfound(body) {
    return buildResponse(404, body);
  }

  function failure(body) {
    return buildResponse(503, body);
  } //! 190314 - refactoring next handler function.


  const doNextAsync = (thiz, callback) =&gt; Promise.resolve(thiz).then(that =&gt; {
    //! decode parameter.
    const ID = that._id;
    const MODE = that._mode || &#039;&#039;;
    const CMD = that._cmd || &#039;&#039;;
    const $param = that._param;
    const $body = that._body;
    const $ctx = that._ctx;
    const next = that._next;
    if (!next) return Promise.reject(new Error(`404 NOT FOUND - mode:${MODE}${CMD ? `, cmd:${CMD}` : &#039;&#039;}`)); // call next.. (it will return result or promised)

    return next(ID, $param, $body, $ctx);
  }).then(_ =&gt; {
    if (_ &amp;&amp; typeof _ === &#039;object&#039;) _ = $U.cleanup(_);
    callback(null, success(_));
    return true;
  }).catch(e =&gt; {
    const message = e &amp;&amp; e.message || &#039;&#039;;

    if (message.indexOf(&#039;404 NOT FOUND&#039;) &gt;= 0) {
      callback(null, notfound(e.message));
    } else {
      _err(NS, &#039;!!! callback err=&#039;, e);

      callback(null, failure(e.message || e));
    }

    return false;
  });
  /** ********************************************************************************************************************
   *  Main Function for API export.
   ** ******************************************************************************************************************* */

  /**
   * basic handler function for lambda serverless
   *
   * @param {*} event         event object
   * @param {*} context       conext object
   * @param {*} callback      callback handler.
   */


  const main = (event, context, callback) =&gt; {
    //! WARN! allows for using callbacks as finish/error-handlers
    context.callbackWaitsForEmptyEventLoop = false; //! API parameters.

    const $param = event.queryStringParameters || {};
    const $path = event.pathParameters || {}; // _log(NS,&#039;$path=&#039;, $path);
    // _log(NS,&#039;headers=&#039;, event.headers);
    //! determine running mode.

    const TYPE = decodeURIComponent($path.type || &#039;&#039;); // type in path (0st parameter).

    const ID = decodeURIComponent($path.id || &#039;&#039;); // id in path (1st parameter).

    const METHOD = !ID &amp;&amp; event.httpMethod === &#039;GET&#039; &amp;&amp; &#039;LIST&#039; || event.httpMethod || &#039;&#039;; // determine method.

    const CMD = decodeURIComponent($path.cmd || event.action || &#039;&#039;); // cmd in path (2nd parameter).
    //! decoding mode.

    const MODE = METHOD_MODE_MAP[METHOD] || (event.Records ? &#039;EVENT&#039; : event.Sns ? &#039;SNS&#039; : &#039;CALL&#039;); //! safe decode body if it has json format. (TODO - support url-encoded post body)

    const $body = event.body &amp;&amp; (typeof event.body === &#039;string&#039; &amp;&amp; (event.body.startsWith(&#039;{&#039;) || event.body.startsWith(&#039;[&#039;)) ? JSON.parse(event.body) : event.body) || event.Records &amp;&amp; {
      records: event.Records
    } || null; //! debug print body.

    if (!$body) {
      _log(NS, `#${MODE}:${CMD} (${METHOD}, ${TYPE}/${ID})....`);
    } else {
      _log(NS, `#${MODE}:${CMD} (${METHOD}, ${TYPE}/${ID}).... body.len=`, $body ? $U.json($body).length : -1);
    } //! prepare chain object.


    const that = {
      _id: ID,
      _mode: MODE,
      _cmd: CMD,
      _param: $param,
      _body: $body,
      _event: event,
      _ctx: context
    };
    that._ctx = event &amp;&amp; event.requestContext || that._ctx || {}; // 180622 Override Context with event.requestContext.

    that._next = decode_next_handler(MODE, ID, CMD); // 190314 Save next-function.
    //! identity 정보를 얻음.
    //  - http 호출시 해더에 x-lemon-identity = &#039;{&quot;ns&quot;: &quot;SS&quot;, &quot;sid&quot;: &quot;SS000002&quot;, &quot;uid&quot;: &quot;&quot;, &quot;gid&quot;: &quot;&quot;, &quot;role&quot;: &quot;guest&quot;}&#039;
    //  - lambda 호출시 requestContext.identity = {&quot;ns&quot;: &quot;SS&quot;, &quot;sid&quot;: &quot;SS000002&quot;, &quot;uid&quot;: &quot;&quot;, &quot;gid&quot;: &quot;&quot;, &quot;role&quot;: &quot;guest&quot;}
    // _log(NS,&#039;headers[&#039;+HEADER_LEMON_IDENTITY+&#039;]=&#039;, event.headers[HEADER_LEMON_IDENTITY]);

    const identity = (val =&gt; {
      try {
        if (!val) return null;
        return typeof val === &#039;string&#039; &amp;&amp; (val.startsWith(&#039;{&#039;) || val.endsWith(&#039;}&#039;)) ? JSON.parse(val) : val;
      } catch (e) {
        _err(NS, &#039;!WARN! parse identity. err=&#039;, e);

        return null;
      }
    })(event.headers &amp;&amp; event.headers[HEADER_LEMON_IDENTITY] || that._ctx.identity || &#039;&#039;);

    if (identity &amp;&amp; !identity.cognitoIdentityPoolId) _inf(NS, &#039;! identity :=&#039;, JSON.stringify(identity));
    that._ctx.identity = identity; //! do the promised task chain.

    doNextAsync(that, callback);
  }; //! returns main handler.


  return main; // ////////////////////////
  // - end of module.exports
};</textarea>
  </div>
</div>

<footer class="footer">
  <div class="container">
    <p>.</p>
  </div>
</footer>

<script type="text/html" id="complexity-popover-template">
  <div class="complexity-notice">
    Complexity : {{ cyclomatic }} <br>
    Length : {{ halstead.length }} <br>
    Difficulty : {{ halstead.difficulty.toFixed(2) }} <br>
    Est # bugs : {{ halstead.bugs.toFixed(2) }}<br>
  </div>
</script>

<script type="text/javascript" src="../../assets/scripts/bundles/core-bundle.js"></script>
<script type="text/javascript" src="../../assets/scripts/bundles/codemirror.js"></script>
<script type="text/javascript" src="../../assets/scripts/codemirror.markpopovertext.js"></script>
<script type="text/javascript" src="report.js"></script>
<script type="text/javascript" src="report.history.js"></script>
<script type="text/javascript" src="../../assets/scripts/plato-file.js"></script>
</body>
</html>
